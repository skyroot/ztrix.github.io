<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Defcon | From Zero To X]]></title>
  <link href="http://blog.ztrix.me/blog/categories/defcon/atom.xml" rel="self"/>
  <link href="http://blog.ztrix.me/"/>
  <updated>2014-08-21T16:01:17+08:00</updated>
  <id>http://blog.ztrix.me/</id>
  <author>
    <name><![CDATA[zTrix]]></name>
    <email><![CDATA[i@ztrix.me]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[DEFCON 22 CTF 总结]]></title>
    <link href="http://blog.ztrix.me/blog/2014/08/20/defcon-22/"/>
    <updated>2014-08-20T15:51:16+08:00</updated>
    <id>http://blog.ztrix.me/blog/2014/08/20/defcon-22</id>
    <content type="html"><![CDATA[<p>Las Vegas 归来已经几天，时差还不经意地骚扰我，顿感身体素质实在不行。</p>

<p>今年 blue-lotus 最终拿到了第五名，还算是一个不错的成绩，于是记录一下今年的得失与教训，回味一下这两周的精彩。</p>

<!-- more -->


<p>吸取了去年航班延误的教训，今年提前了两天出发，于 8 月 5 日出发，继续坐最便宜的 UA888。去年延误给的 10% off 的 coupon 在真正购买机票的时候居然不能使用，不得不怒吐一槽。</p>

<p>巧的是在北京国际机场碰上了即将去 blackhat 演讲的教主 <a href="http://weibo.com/tombkeeper">tombkeeper</a>，近距离感受了一下 “面有萌色，心有丘壑" 的大师风范。路上我们一直期待教主给我们讲讲段子，特别是演示一下如何给出一个 <a href="http://weibo.com/1401527553/BfXaRiG4j">“小伙子好好干”</a> 眼神，可惜一直未能如愿。</p>

<p>今年的赛前准备做的还是比较充分的，比赛前两天又继续增强了通用防御的一些技术和自动攻击框架，同时去超市买了一大堆吃的和饮料（今年领队老师和马杰的签证都悲剧了，目测就要没人给我们各种订餐了，TT）。<a href="https://www.blackhat.com/">Kelwin</a> 还忙里偷闲去 <a href="https://www.blackhat.com/">blackhat</a> 逛了一圈。</p>

<p>然而比赛前还是出现了各种不顺利的事情，首先是 <a href="https://www.blackhat.com/">Kelwin</a> 的 老年 MBP 实在招架不住，镁光 SSD 直接 crash，启动不能（一查居然是多年前的镁光 SSD 固件门，这个发作时间真是巧的无奈），于是 <a href="https://www.blackhat.com/">Kelwin</a> 信用卡一掏，立刻去 apple store 买了一个新的 rmbp。（估计他想着旧的 MBP 回国换个硬盘还能继续使用，结果回国之后发现遇上机场暴力托运，MBP 的屏幕已坏。。感谢为 blue-lotus 积攒 RP，队长功不可没。。）</p>

<p>第二件不顺利的事情在于现场的网络环境配置。今年的环境和去年又有所不同，虽然仍然是一根网线进来，但是内网和外网通过 tagged vlan 来区分，然而我们并没有带支持 vlan 的网络设备。虽然临时买了一个 linksys 高端路由器号称支持 vlan，但是试用之后发现不能同时支持两个 vlan，只好放弃。</p>

<p>5 号早上 9 点赶到现场搭建网络，10 点就会开始比赛，于是只有紧张的一个小时来配置 vlan，好在我们带了几个额外的机器，于是就先取 mac mini。悲剧的事情是我们没有显示器，在我一次强制断电之后，mac mini 似乎直接挂了，不能启动，没办法只好借了一个显示器过来，发现 mac mini 在漫无休止地检查硬盘。于是前功尽弃，只好立刻换另外一个 samsung 笔记本来作为网关，又折腾了很久，等完全折腾好网络，队员可以同时正常访问内外网的时候，已经 12 点了，于是开赛一个小时的时间又手忙脚乱的就浪费掉了，和去年一样，硬件准备还是不够充分，一开赛就甚为慌乱，实在不是一个好事情，这里不得不检讨。</p>

<p>第三件不顺利的事情仍然来自于硬件准备，虽然带够了网络设备，网线，插线板，但是我方设备仍然实在太弱，网线都很短，插线板也很短，乱七八糟的散乱在地上，队员进出实在不便，好几次碰掉了电源，幸好没有碰掉网线造成悲剧。但是看其他队伍各种高大上的设备箱，还带有五颜六色灯光闪烁效果，就知道差距太大。未来如果还有机会，至少要带线足够长的网线和插线板，全部部署在桌子上，井井有条，至少给自己队员带来心理上的条理感，不至于太过慌乱。此乃一个教训。</p>

<h2>8 月 8 日，比赛第一天</h2>

<p>比赛形式与去年大同小异，甚至连规则都不发布了。仍然是 odroid 的 ARMv7 开发板，所不同的是，使用了 qemu 运行了 x86 等不同架构的 binary，甚至还有个 badge，是 MSP430 单片机，于是今年实际上是多架构平台，这增加了不小的挑战。</p>

<p>比赛开始我们就准备部署一些通用防御措施，然而做逆向的童鞋很快发现 binary 里面存在诸如读取 /dev/ctf 来做验证的保护措施，于是只能放弃了一些比较激进的防御措施，先静观其变。</p>

<p><img src="/images/defcon-22/2014-08-08_11-51-51.png" alt="defcon 22 scoreboard" /></p>

<p>上午 11 点，最后的亚军 HITCON 因为做了通用防御无法通过检查，导致服务丢分，暂时排在最末，比赛季军 Dragon Sector 可能也做了类似的事情，导致倒数第二。我们由于发现的早，分数基本没扣，于是暂时排在前列。</p>

<p>今年的服务比去年感觉有所简单，当然也有可能是大家都有了 IDA Arm decompiler 的缘故，刚到下午就开始有队伍得分，分数开始发生变化。</p>

<p><img src="/images/defcon-22/2014-08-08_15-34-25.png" alt="defcon 22 scoreboard" /></p>

<p>HITCON 反应迅速，很快就升到了前面。我们 replay 的速度也不错，加上修补漏洞比较快，于是侥幸排在第二。</p>

<p>第一天感觉下来，在漏洞挖掘上，还是和强队差距很大，我们基本都是在被打的时候，快速反应，快速修补，快速 replay，于是勉强撑过了第一天。第一天结束的时候，我们还没有自己的主动攻击，只有防御做的还算是有一些效果。</p>

<p><img src="/images/defcon-22/2014-08-08_19-35-18.png" alt="defcon 22 scoreboard" /></p>

<p>第一天快结束的时候的分数榜。</p>

<p>结束以后，我们赶紧回住处草草吃了点饭，开始继续分析。</p>

<h2>8 月 9 日，比赛第二天</h2>

<p>一夜的分析还是有所收获的，无论如何，我们是带着主动攻击来了，并且一开赛就可以拿 10 余支队伍的 flag，于是打出了一波小高潮。可惜第二天主办方为了防止分数悬殊太大给后面的队伍带来心理压力以至于放弃，就关闭了分数榜，只留名次榜。</p>

<p>只可惜好景不长，各支队伍修补的速度也很快。到了下午，我们的攻击就基本上无法有效进行了，获取的 flag 也很零星，然后上了新服务，我们四处被打，手忙脚乱，十分狼狈。</p>

<p>经过前一天几乎通宵的分析，到了下午大家也都十分疲倦，cbmixx 直接在椅子上打了瞌睡，libmaru 直接表示太困太吵于是就先回住处了。</p>

<p>第二天的中间几个小时是最煎熬的一段时间。也是非常有可能守不住就不断掉名次的时候。</p>

<p>好在熬了几个小时大家终于稍微能振奋一点了，几个服务修补的也还算及时，虽然被打了不少时间。但是在这种慌乱情况下，我们发现的几个漏洞，都没有时间去写攻击。仅有的几个攻击脚本，也都因为太老，而基本攻击不成，而强队又开始不断的发起新的攻击，PPP 的 justify 新攻击一次性可以拿十几只队伍 flag，HITCON 的 eliza 也非常猛。我们在列强的夹击下非常艰难。</p>

<p>主办方放出了攻击视频 <a href="http://youtu.be/1UT3qXHduts">http://youtu.be/1UT3qXHduts</a> ，有人说我们打法太过保守，既不攻击别人，也不怎么被别人攻击。实际情况是这个时候我们已经四处挨打了，能补上几个漏洞已经是万幸，想要攻击出去早已无力。</p>

<p><img src="/images/defcon-22/2014-08-09_19-06-26.png" alt="defcon 22 scoreboard" /></p>

<p>第一天快结束时的名次，虽然名次还在前面，但是我们心里知道与强队的差距，这是不可忽视的。</p>

<p>今年的防御部分我们确实做了很有效的措施，常见的漏洞都先使用 binary harden 的方法，对栈漏洞，直接进行改大栈帧，对 UAF，直接 patch 掉 free 操作等，于是至少可以挡住第一波的进攻。当稳定下来以后，我们再进一步做深度修补，这取得了非常好的效果。这里不得不提及一下 HITCON 思路新颖，他们的栈漏洞 binary harden 方法是直接把栈迁移到环境变量区，于是在一定程度上使得利用非常困难，甚至可以算是彻底修复了栈漏洞，这个比我们加大栈帧的方法高明了不少，确实是一流队伍出奇招啊。</p>

<p>第二天我们仍然尝试做了几个通用防御，结果要么是过不了 SLA 检查，要么就太过激进被主办方警告了，于是便全部放弃了，只留了 inotify flag 检测。</p>

<p>第二天比赛中间安恒老板范渊，还有腾讯等好几拨人过来给我们带了不少吃的，还有不少人也过来支持鼓励我们，非常感谢！没有领队老师在的时候，都靠业界前辈支持了。只不过我们比赛过程中，实在是又累又困又紧张又慌乱，抽不出空与各位朋友好好交流，并不是某位小编说的态度不可一世爱理不理，这希望能够得到大家理解。</p>

<p>另外不得不再次怒吐一槽的是，Rio 居然强制要求所有赛场队伍必须订他们指定外卖，只能付现金，并且不找零钱，强制霸王条款，让人不可理喻。好玩的是 DEFCON closing ceremony 上立刻就宣布明年就不在 Rio 办了，太贵太坑，明年要去 <a href="http://www.ballyslasvegas.com/">Bally</a></p>

<h2>8 月 10 日，比赛第三天，最后的决战</h2>

<p>比赛最后一天只有 4 个小时，但仍然激烈，程度不亚于第二天，因为会有一大波 0day 四面八方砸来。</p>

<p>经过一个晚上又是几乎一个通宵，我们修补了大部分漏洞，并且又写了几个攻击，于是第三天早上，又打出了一小波攻击，但是无济于事，强队实在过于强大，实际上我猜测分数还是在下降的。这个时候 PPP HITCON 还有 Dragon Sector 都显然比我们强很多，我们后面的 Reckless Abandon 和 Men in black hat 进攻势头也很猛，都很有可能超过我们。</p>

<p>然而第三天还是出现了一些状况，使得状况变得更加糟糕。</p>

<p>第一个比较郁闷的事情是，其中有一个服务我们花了将近 2 个小时修补完了，结果被对手放了后门，并且会自动 fork ，kill 的速度比不过 fork 的速度，于是我们的自动 kill shell 脚本没有把后门 kill 掉。后来我们才知道对于这种后门应该先发送 STOP 信号。于是就这样无辜丢了可能将近 250 分。</p>

<p>第二个也很郁闷的事情是，<a href="https://www.blackhat.com/">kelwin</a> 的 eliza 攻击脚本已经差不多写完了，然而发现远程攻击速度太慢，还是不能正常获取 flag，等于白白浪费了时间，一直到比赛结束都没有能进行自动攻击，非常可惜。</p>

<p>第三个更加郁闷的事情是，badge 服务第三天有队伍进行了 dos 攻击，我们前面分析了很久的 badge，虽然不能攻击，但是对服务比较熟，于是很快 patch 了这个 dos 攻击的漏洞。于是如果这个攻击一直进行的话，我们将会因为别人的服务 down 掉获取很多分数，结果主办方突然就宣布这个 dos 攻击是不允许的，于是 badge 上我们就几乎没有得分，或者也可能拿了其中一两轮的分数，但是由于我们自己刷 rom 还要 down 一两轮，所以最终都不知道是得分了还是丢分了。</p>

<p>badge 是主办方耗费了不少心血设计的题目，很可惜由于出现各种问题，包括中心服务器的问题等，导致 PPP 早就搞定了没有得分，一直到最后才有 Routards 拿分，但是也基本无法改变局势了，不然一定会造成排名大变。对于主办方是一个非常可惜的事情。</p>

<p>另外还有一个很好玩的事情是，许多队伍的通用防御都做了 shell 命令检测过滤，于是大家都开始写花命令来获取 flag。从最开始最简单的 <code>cat flag</code>，后来慢慢越来越复杂，最后命令变成了</p>

<p><code>
A="fla"; B="g"; /usr/b${nyaL}in/ba${blah}se64 "$A$B"
</code></p>

<p>这个检测和防御我们并没有做，如果做的话还是有一定迷惑效果的，以后应该做一下。</p>

<p>由于最后一天主办方完全封榜，看不到分数和排名，大家都是在盲打盲撞，还是比较忐忑的。比赛结束之后，感觉了一下，前三名很可能是 PPP HITCON 和 Dragon Sector，结果果然正好猜中，恭喜他们，特别是 HITCON 和 Dragon Sector 都是第一年参加 DEFCON 决赛，实属不易，令人钦佩。</p>

<p><img src="/images/defcon-22/final.png" alt="defcon 22 scoreboard" /></p>

<p>比赛最终结果在一周后揭晓了，我们处在第五名，与预测差别不大，还是很开心的，毕竟今年实现了突破，实现了快速修补防御，实现了主动攻击，名次上也超过了目标预期，各方面都算是稳步进步了。</p>

<h1>感谢</h1>

<p>最后要感谢安全宝鼎力赞助支持，支持这么多人参加决赛实在是不小的开销。也感谢安恒范渊(给我们买 Pizza 送饮料，帮忙解决不少后勤问题)、腾讯（有两个部门都请我们吃了饭来支持）、<a href="http://weibo.com/tombkeeper">tombkeeper</a> 的鼓励，还有各位来自于阿里等业内公司的朋友，我无法记住全部，在此只能一并道谢！</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Defcon 20 小记]]></title>
    <link href="http://blog.ztrix.me/blog/2012/06/08/defcon-ctf-quals-20/"/>
    <updated>2012-06-08T23:35:35+08:00</updated>
    <id>http://blog.ztrix.me/blog/2012/06/08/defcon-ctf-quals-20</id>
    <content type="html"><![CDATA[<p>6 月 2 号到 4 号有幸加入 blue-lotus 参加了 defcon CTF 2012 的比赛，感慨颇深。清华第一次组队参加这个比赛，虽然没进决赛，但第一次参赛能进前 20，也算不错的成绩了。</p>

<!-- more -->


<p>第一次参加 CTF，对于题目最大的感觉就是没有头绪。其实题目涉及面太广，许多题目了解背景知识很快即可破题，不知道的人，想破脑袋也解不出。比如 Forensics 100 的题目，给了个文件系统，大家全在文件系统里面翻，看到一堆又一堆的头文件，但是就是没有结果。等到赛后看了 writeup，发现使用 <a href="http://www.sleuthkit.org/">STK</a> 用一行命令就能得到 key:</p>

<pre><code>blkls -s f100_xxx
</code></pre>

<p>大家大呼坑爹，这谁知道啊！！为什么这样得到的是 key 啊！！有没有什么解释啊！！</p>

<p>但是事实是无情的，虽然是 100 分的题目，只要一个命令，但是我们就是解不出来，而各国牛队则瞬秒。这也许就是经验的差距吧。</p>

<h2>Grab Bag</h2>

<p>Grab Bag 的题目普遍简单，5 道题目我们解出来 4 题，最后的 500 分题到现在 writeup 都没出来，估计也没几个队做出来了。</p>

<h3>grab bag 100</h3>

<p>gb100 的题目就一句话： <code>hack the planet_</code>。我就一直在思考为啥 planet 后面是个下划线。结果没过几分钟，我们组就有人做出来了，key 就是一个 <code>!</code>，当时也没多想，现在才发现，下划线的意思是在最后填一个 <code>char</code>，<code>hack the planet!</code> 可能是一句 hack 文化里面的 slang 吧。所以没有点背景知识就来打酱油真不行。</p>

<h3>grab bag 200</h3>

<p>gb200 的题目是给一个图片和一个 mac double format 文件，mac double format 里面藏了一个链接链到图片的原文件，对比一下发现给的图片后面附加了一个 DNS PTR 查询包。于是大家都想到了构造这个包再发一遍，但是，结果别人得到了结果，我没得到。悲剧！等到赛后看 writeup，发现原来我没有把 source port 指定相同。唉！就差了一步呀。</p>

<h3>grab bag 300</h3>

<p>gb300 是个破解 ATM 取款机的题目，组里有人一眼就看出了规律，太强了！但是人眼看速度不够，只好写程序，好吧，我写得没别人快，就没继续做了。</p>

<h3>grab bag 400</h3>

<p>gb400 是个 SQL 注入，组里有强人立刻就发现了漏洞入口了，好强。没有注入经验，果断不会，好在有强人在，很快解决了。</p>

<h2>Random</h2>

<h3>random 100</h3>

<p>random100 也是让人摸不着头脑的题目，题目是一句话：</p>

<pre><code>How many developers;) did it take to secure Windows 8?
</code></pre>

<p>key 是 152，看了 writeup 也不知道为啥，甚至当时大家做出来的时候，都不知道谁做出来了。我当时写了个脚本把 1 到 1000 都遍历提交了一遍，莫非是我解决的？好开心！</p>

<h3>random 200</h3>

<p>random200 果断不会，今天看 <a href="http://devtrixlabs.com/blog/2012/06/defcon-2012-urandom-200-writeup/">writeup</a>，发现前面都正常，到了最后，作者发现了这个的时候：</p>

<pre><code>fr an
it ha
hi ez
jp er
en-us !!
</code></pre>

<p>他居然直接就猜出了 key 是 <code>icanhazcheezburger!!</code> 。这也太假了吧！！莫非是有我们不知道的 hacker 典故？还是这个人是脑力王？？</p>

<h3>random 300</h3>

<p>random 300 是最 straight forward 的一到题目了，要求用足够少的交换次数把 100000 个 uint16 排序。我开始怕超时写了个 qsort，结果发现交换次数太多。然后准备写 O(n<sup>2</sup>) 的 selection sort，达到最多交换次数 N-1。结果写到一半又被别人抢先了。悲剧！</p>

<h2>Forensics</h2>

<p>binary 和 pwnable 的题都要求 binary 调试，还是各种 MIPS Binary，FreeBSD，我果断看都没看。不过取证这块还是可以看看的。</p>

<h3>Forensics 200</h3>

<p>大家都盯着那几个图片看了。结果又是一道工具题，不知道的人果断是解不出来的，结果也就几行命令：</p>

<pre><code>stegdetect -s 2 2467trash.jpg
outguess -r -e -k “ddtek” 2467trash.jpg key
</code></pre>

<p>原来是道 Steganography 的题目。好吧，现在懂了，不过这个 outguess 里面用到的 ddtek 是怎么来的，writeup 作者说是用了一个字典搜的，换作我们，即使知道用 outguess 也猜不出 key 吧，谁的字典里会有 ddtek ?</p>

<h3>Forensics 300</h3>

<p>Hooray! 这是我唯一解出来并提交的题目！大概就是给了个 OpenWRT 的 firmware 镜像，用 <a href="http://code.google.com/p/firmware-mod-kit/">firmware-mod-kit</a> 解一下，就能得到答案了。太开心了！</p>

<h2>Binary</h2>

<p>突然想起来，其实还是看了一道 binary 题目的，就是 bin 100 的题目。这也是一道好可惜的题目。题目给了一个用 skynet 漏洞的 ssh 和它的输出文件 mac.h，我们也发现了 mac.h 是用直接去反编码的 ASCII。但是谁知道 key 就在里面！！我们都跑去分析给的另外两个 ssh 和 sshd 了。好在最后还是做出来了。不知道是谁试的。其实我印象中记得我把 mac.h 里面的字符串都试了一遍，为啥我们试出来？RPWT？</p>

<h2>总结</h2>

<p>Anyway，比赛已经过去。很高兴能认识很多安全领域的牛人，也很开心打酱油也能做出题来。发个结果图和名字纪念一下吧！期待明年再战！</p>

<p><a href="http://repo.shell-storm.org/CTF/Defcon-20-quals/Scoreboard.txt">最终排名</a> 和最终解题结果：</p>

<p><img class="middle" src="/images/defcon-20-blue-lotus.jpg" title="&lsquo;defcon 20 quals rank&rsquo;" ></p>

<p>其中绿色是我们解出来的题目，蓝色是我们没解出来，但是有队伍解出来的题目，灰色是还没开放的题目。紫色是当前在做的题目。再发个链接：<a href="http://devpsc.blogspot.jp/2012/06/defcon-20-quals-writeup-collection.html">writeup collection</a></p>
]]></content>
  </entry>
  
</feed>
